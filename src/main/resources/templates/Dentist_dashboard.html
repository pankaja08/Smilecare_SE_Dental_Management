<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmileCare • Dentist Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap');

        /* All of your existing CSS is unchanged */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f4f7fc; color: #333; line-height: 1.6; }
        .app-shell { display: flex; min-height: 100vh; position: relative; }
        .content { flex: 1; padding: 20px; }
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(to right, #4facfe, #fdffff);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .website-name {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 1px;
        }
        .profile-section { display: flex; align-items: center; }
        .profile-card {
            background: #fff;
            border-radius: 10px;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
            position: relative;
        }
        .profile-card:hover { transform: translateY(-2px); }
        .profile-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3498db;
        }
        .profile-info h3 { font-size: 18px; color: #2c3e50; margin-bottom: 3px; }
        .profile-info p { font-size: 12px; color: #7f8c8d; }
        .stats-cards {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .stats-cards .card {
            flex: 1;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            background: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #card-appointments i {
            font-size: 40px;
            color: #007bff; /* blue */
        }
        #card-appointments h2 {
            color: #007bff;
        }
        #card-xray-requests i {
            font-size: 40px;
            color: #ff9800; /* orange */
        }
        #card-xray-requests h2 {
            color: #ff9800;
        }
        .menu-icon {
            cursor: pointer;
            font-size: 18px;
            color: #7f8c8d;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.3s;
        }
        .menu-icon:hover { color: #3498db; }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            z-index: 1000;
            min-width: 120px;
        }
        .dropdown-menu button {
            width: 100%;
            padding: 10px 20px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #ea6051;
            transition: background 0.3s;
        }
        .dropdown-menu button:hover { background: #f9fbfd; }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            cursor: pointer;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .card i { font-size: 24px; color: #3498db; margin-bottom: 10px; display: block; }
        .card h2 { font-size: 28px; color: #3498db; margin-bottom: 8px; }
        .card p { font-size: 14px; color: #7f8c8d; }
        .row { display: flex; gap: 25px; margin-bottom: 25px; }
        .row > div { flex: 1; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
        thead tr { border-bottom: 2px solid #ecf0f1; }
        th, td { padding: 12px 15px; text-align: left; font-size: 14px; color: #2c3e50; }
        th { background: #ecf0f1; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        td img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; vertical-align: middle; border: 1px solid #ddd; }
        td:hover { background: #f9fbfd; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: background 0.3s, transform 0.2s; }
        .btn-accept { background: #23eb76; color: #fff; margin-right: 8px; }
        .btn-accept:hover { background: #00ff73; transform: scale(1.05); }
        .btn-reject { background: #ff6c5c; color: #fff; }
        .btn-reject:hover { background: #ff0000; transform: scale(1.05); }
        .btn-details { background: #3498db; color: #fff; }
        .btn-details:hover { background: #2980b9; }
        .calendar { display: flex; flex-direction: column; max-width: 280px; min-height: 300px; }
        .calendar-header { display: flex; justify-content: space-between; margin-bottom: 10px; padding: 5px; background: #ecf0f1; border-radius: 6px; }
        .calendar-header button { border: none; background: none; font-size: 16px; cursor: pointer; color: #3498db; padding: 5px 10px; border-radius: 4px; transition: background 0.3s; }
        .calendar-header button:hover { background: #dfe6e9; }
        .calendar-days, .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .calendar-days { font-weight: 600; color: #2c3e50; margin-bottom: 8px; padding: 10px 0; }
        .calendar-grid div { padding: 8px; border-radius: 50%; aspect-ratio: 1 / 1; font-size: 11px; color: #2c3e50; transition: background 0.3s, color 0.3s; }
        .calendar-grid div:hover { background: #dfe6e9; color: #2980b9; }
        .calendar-grid div.today { background: #3498db; color: #fff; font-weight: 600; border: 2px solid #2980b9; }
        .appointment-requests table tbody tr { background: #fff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); transition: transform 0.3s; }
        .appointment-requests table tbody tr:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            color: #3498db;
            font-weight: bold;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #2c3e50;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .full-width { width: 100%; }
        .details-row { background: #f9fbfd; }
        .xray-request { padding: 15px; border-top: 1px solid #ecf0f1; }
        .xray-request h4 { margin-bottom: 10px; color: #2c3e50; }
        .xray-request textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; resize: vertical; }
        .xray-request button { margin-bottom: 10px; }
        .thumbnail { max-width: 200px; height: auto; cursor: pointer; border: 1px solid #ddd; border-radius: 6px; margin-top: 10px; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            padding-top: 60px;
        }
        .modal-content { margin: auto; display: block; max-width: 90%; max-height: 90%; width: auto; height: auto; }
        .close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: #bbb; text-decoration: none; cursor: pointer; }

        @media (max-width: 768px) {
            .stats-cards { grid-template-columns: 1fr; }
            .row { flex-direction: column; }
            .calendar { max-width: 100%; }
            .header-section { flex-direction: column; gap: 15px; text-align: center; }
        }

        .x-ray-requests-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .create-request-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .create-request-btn:hover {
            background-color: #2980b9;
        }

        .x-ray-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .x-ray-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            border: 1px solid #ecf0f1;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .x-ray-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .x-ray-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .x-ray-card .card-header h3 {
            font-size: 1.1rem;
            color: #2c3e50;
            margin: 0;
        }

        .x-ray-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .x-ray-status.status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .x-ray-status.status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .x-ray-card p {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #333;
        }
        .x-ray-card p strong {
            color: #7f8c8d;
            min-width: 100px;
            display: inline-block;
        }

        .x-ray-card .card-actions {
            margin-top: auto; /* Pushes actions to the bottom */
            padding-top: 15px;
            text-align: right;
        }

        .btn-view-xray {
            background-color: #28a745; /* green */
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-view-xray.disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .no-requests-message {
            text-align: center;
            grid-column: 1 / -1; /* Span across all columns */
            color: #7f8c8d;
            padding: 40px;
            font-style: italic;
        }

        /* Modal for X-ray Request Form */
        .x-ray-form .form-group {
            margin-bottom: 15px;
        }
        .x-ray-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        .x-ray-form input, .x-ray-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .x-ray-form input:focus, .x-ray-form textarea:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        .x-ray-form input[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        .x-ray-form textarea {
            resize: vertical;
            min-height: 80px;
        }
        .x-ray-form .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }
        .x-ray-form .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .x-ray-form .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* X-ray Requests Table Styles */
        .xray-requests-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        .xray-requests-table th {
            background: #ecf0f1;
            color: #2c3e50;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .xray-requests-table td {
            padding: 12px 12px;
            border-bottom: 1px solid #ecf0f1;
            color: #2c3e50;
            transition: background-color 0.2s ease;
        }
        .xray-requests-table tr:hover td {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
<div class="app-shell">
    <main class="content">
        <!-- Replace the hardcoded profile section with Thymeleaf -->
        <!-- In Dentist_dashboard.html - REVERT to original but keep Thymeleaf for basic data -->
        <section class="header-section">
            <div class="website-name">SmileCare</div>
            <div class="profile-section">
                <div class="profile-card">
                    <!-- Use original hardcoded image for now -->
                    <img src="/image/nilusha11.jpg" alt="Dentist Profile" id="doctor-profile-img">
                    <div class="profile-info">
                        <h3 id="doctor-name">Dr. <span th:text="${dentist.fullName}">Loading...</span></h3>
                        <p id="doctor-title"><span th:text="${displaySpecialization}">Loading...</span> • SmileCare Dental Clinic</p>
                    </div>
                    <div class="menu-icon" onclick="toggleMenu()">
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                    <div id="profile-menu" class="dropdown-menu">
                        <form th:action="@{/logout}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg text-red-600 hover:bg-red-50 transition-colors">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section class="stats-cards">
            <div class="card" id="card-appointments">
                <i class="fas fa-calendar-check"></i>
                <h2 id="appointments-count">0</h2>
                <p>Appointment Requests</p>
            </div>
            <div class="card" id="card-xray-requests">
                <i class="fas fa-x-ray"></i>
                <h2 id="xray-requests-count">0</h2>
                <p>X-ray Requests</p>
            </div>
        </section>

        <section class="row">
            <div class="appointment-requests">
                <h3>Appointment Requests</h3>
                <table id="requests-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Patient</th>
                        <th>Note</th>
                        <th>Date/Time</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="calendar">
                <div class="calendar-header">
                    <button id="prev-month">&lt;</button>
                    <span id="month-year"></span>
                    <button id="next-month">&gt;</button>
                </div>
                <div class="calendar-days">
                    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div>
                    <div>Fri</div><div>Sat</div><div>Sun</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </section>

        <section class="row">
            <div class="accepted-appointments">
                <h3>Accepted Appointments</h3>
                <table id="accepted-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Note</th>
                        <th>Date/Time</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="xray-requests">
                <h3>X-ray Requests</h3>
                <table class="xray-requests-table" id="xray-requests-table">
                    <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Description</th>
                        <th>Request Date</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section class="x-ray-requests-section full-width">
            <div class="section-header">
                <h3>Detailed X-ray Requests</h3>
                <button id="createXRayRequestBtn" class="btn create-request-btn">
                    <i class="fas fa-plus-circle"></i> Create X-ray Request
                </button>
            </div>
            <div id="xRayRequestsContainer" class="x-ray-cards-container">
            </div>
        </section>

    </main>

    <div id="xRayRequestModal" class="modal">
        <div class="modal-content" style="max-width: 500px; background: white; padding: 0; border-radius: 10px; margin: 5% auto;">
            <div style="background: #3498db; color: white; padding: 15px 20px; border-top-left-radius: 10px; border-top-right-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 1.2rem; margin: 0;"><i class="fas fa-x-ray"></i> Create X-ray Request</h2>
                <button id="closeXRayRequestModal" class="close" style="font-size: 24px; background: none; border: none; color: white; position: static; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>
            <div style="padding: 25px;">
                <form id="xRayRequestForm" class="x-ray-form" onsubmit="handleXRayRequestSubmit(event)">
                    <div class="form-group">
                        <label for="xRayPatientName">Patient Name</label>
                        <input type="text" id="xRayPatientName" name="patientName" required>
                    </div>
                    <div class="form-group">
                        <label for="xRayDescription">X-ray Description</label>
                        <textarea id="xRayDescription" name="description" rows="4" placeholder="e.g., Full mouth panoramic, check for caries on molars..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="xRayRequestDate">Request Date</label>
                        <input type="date" id="xRayRequestDate" name="requestDate" readonly>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelXRayRequest">Cancel</button>
                        <button type="submit" class="btn create-request-btn"><i class="fas fa-paper-plane"></i> Send Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="xrayImageModal" class="modal">
        <span class="close" id="closeXrayImageModal">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

</div> <script>
    // --- CSRF TOKEN HELPER & API BASE ---
    const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
    const csrfHeaderName = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
    const API_BASE = '/api';
    let currentDentist = null;

    // --- DOCTOR PROFILE MAPPING ---
    const DOCTOR_PROFILES = {
        'nilusha': {
            name: 'Nilusha Sudharaka',
            image: '/image/nilusha11.jpg',
            title: 'General Dentist • SmileCare Dental Clinic'
        },
        'pankaja': {
            name: 'Pankaja Yunidu',
            image: '/image/panke.jpg',
            title: 'Orthodontics Specialist • SmileCare Dental Clinic'
        },
        'thisuka': {
            name: 'Thisuka Senan',
            image: '/image/Senan.jpg',
            title: 'Pediatric Dentist • SmileCare Dental Clinic'
        },
        'nadara': {
            name: 'Nadara Wanigasekara',
            image: '/image/nadara.jpg',
            title: 'Oral Surgeon • SmileCare Dental Clinic'
        },
        'amasha': {
            name: 'Amasha Sawandi',
            image: '/image/Amasha.jpg',
            title: 'Periodontist • SmileCare Dental Clinic'
        }
    };

    // Function to set doctor profile based on URL parameter
    function setDoctorProfileFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const dentistParam = urlParams.get('dentist');

        const doctor = DOCTOR_PROFILES[dentistParam] || DOCTOR_PROFILES['nilusha']; // default to Nilusha

        const profileImg = document.getElementById('doctor-profile-img');
        const profileName = document.getElementById('doctor-name');
        const profileTitle = document.getElementById('doctor-title');

        profileImg.src = doctor.image;
        profileName.textContent = doctor.name;
        profileTitle.textContent = doctor.title;
    }

    // --- YOUR EXISTING UI FUNCTIONS (UNCHANGED) ---
    function generateCalendar(year, month) {
        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById("month-year").textContent = `${monthNames[month]} ${year}`;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        const adjustedFirstDay = (firstDay + 6) % 7;
        for (let i = 0; i < adjustedFirstDay; i++) grid.appendChild(document.createElement("div"));
        for (let day = 1; day <= daysInMonth; day++) {
            const div = document.createElement("div");
            div.textContent = day;
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                div.classList.add("today");
            }
            grid.appendChild(div);
        }
    }
    function toggleMenu() {
        const menu = document.getElementById('profile-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    function formatDateTime(dateString, timeString) {
        if (!dateString || !timeString) return 'N/A';
        const dateTime = new Date(`${dateString}T${timeString.split(' ')[0].padStart(5, '0')}:00`);
        return dateTime.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) + ', ' + dateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // --- DATA LOADING & ACTIONS (UPDATED FOR BACKEND) ---

    document.addEventListener('DOMContentLoaded', async function() {
        // Set doctor profile first
        setDoctorProfileFromURL();

        await loadCurrentDentist();

        if (currentDentist) {
            loadAppointmentRequests();
            loadAcceptedAppointments();
            loadXRayRequestsTable(); // New function for the table view
            loadXRayRequests(); // Existing function for the card view
        }

        let currentDate = new Date();
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        document.getElementById("prev-month").onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); };
        document.getElementById("next-month").onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); };

        // --- X-RAY MODAL EVENT LISTENERS ---
        const createXRayRequestBtn = document.getElementById('createXRayRequestBtn');
        const xRayRequestModal = document.getElementById('xRayRequestModal');
        const closeXRayRequestModal = document.getElementById('closeXRayRequestModal');
        const cancelXRayRequest = document.getElementById('cancelXRayRequest');
        const xRayRequestForm = document.getElementById('xRayRequestForm');
        const xRayRequestDateInput = document.getElementById('xRayRequestDate');

        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            xRayRequestDateInput.value = `${yyyy}-${mm}-${dd}`;
        }
        createXRayRequestBtn.addEventListener('click', () => {
            xRayRequestModal.style.display = 'block';
            xRayRequestForm.reset();
            setTodayDate();
        });
        function closeXRayFormModal() {
            xRayRequestModal.style.display = 'none';
        }
        closeXRayRequestModal.addEventListener('click', closeXRayFormModal);
        cancelXRayRequest.addEventListener('click', closeXRayFormModal);

        const xrayImageModal = document.getElementById('xrayImageModal');
        document.getElementById('closeXrayImageModal').onclick = () => {
            xrayImageModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == xrayImageModal) {
                xrayImageModal.style.display = 'none';
            }
            if (event.target == xRayRequestModal) {
                closeXRayFormModal();
            }
        };
    });

    async function loadCurrentDentist() {
        try {
            const response = await fetch(`${API_BASE}/dentists/me`);
            if (!response.ok) throw new Error('Could not fetch dentist details.');
            currentDentist = await response.json();

            console.log("DEBUG: Loaded current dentist:", currentDentist);

            // Update the UI with the actual dentist data
            updateDentistProfile(currentDentist);

        } catch (error) {
            console.error('Error loading current dentist:', error);
        }
    }

    function updateDentistProfile(dentist) {
        const profileImg = document.getElementById('doctor-profile-img');
        const profileName = document.getElementById('doctor-name');
        const profileTitle = document.getElementById('doctor-title');

        // Map dentist names to images and specializations
        const dentistProfiles = {
            'Nilusha Sudharaka': {
                image: '/image/nilusha 11.jpg',
                specialization: 'General Dentistry'
            },
            'Pankaja Yunidu': {
                image: '/image/panke.jpg',
                specialization: 'Orthodontics'
            },
            'Thisuka Senan': {
                image: '/image/Senan.jpg',
                specialization: 'Pediatric Dentistry'
            },
            'Nadara Wanigasekara': {
                image: '/image/nadara.jpg',
                specialization: 'Oral Surgery'
            },
            'Amasha Sawandi': {
                image: '/image/Amasha.jpg',
                specialization: 'Periodontics'
            },
            'Vishwa Nethsara': {
                image: '/image/default-dentist.jpg',
                specialization: 'Cosmetic Dentistry'
            }
        };

        const profile = dentistProfiles[dentist.fullName] || {
            image: '/image/default-dentist.jpg',
            specialization: 'General Dentist'
        };

        // Update the UI
        profileImg.src = profile.image;
        profileName.textContent = 'Dr. ' + dentist.fullName;
        profileTitle.textContent = profile.specialization + ' • SmileCare Dental Clinic';

        console.log("DEBUG: Updated profile for:", dentist.fullName);
    }

    async function loadAppointmentRequests() {
        try {
            const response = await fetch(`${API_BASE}/appointments/dentist?status=PENDING`);
            const appointments = await response.json();
            const tbody = document.querySelector("#requests-table tbody");
            tbody.innerHTML = '';

            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No pending appointment requests.</td></tr>';
            } else {
                appointments.forEach(appt => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
        <td>${appt.id}</td>
        <td>${appt.patientName}</td>
        <td>${appt.appointmentNotes || 'No notes provided'}</td>
        <td>${formatDateTime(appt.appointmentDate, appt.preferredTime)}</td>
        <td>
            <button class="btn btn-accept" onclick="updateAppointmentStatus(${appt.id}, 'ACCEPTED')">Accept</button>
            <button class="btn btn-reject" onclick="updateAppointmentStatus(${appt.id}, 'REJECTED')">Reject</button>
        </td>
    `;
                    tbody.appendChild(row);
                });
            }
            document.getElementById("appointments-count").textContent = appointments.length;
        } catch (error) {
            console.error('Error loading appointment requests:', error);
            document.querySelector("#requests-table tbody").innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading requests.</td></tr>';
        }
    }

    async function loadAcceptedAppointments() {
        try {
            const response = await fetch(`${API_BASE}/appointments/dentist?status=ACCEPTED`);
            const appointments = await response.json();
            const tbody = document.querySelector("#accepted-table tbody");
            tbody.innerHTML = '';

            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No accepted appointments.</td></tr>';
            } else {
                appointments.forEach(appt => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${appt.id}</td>
                        <td>${appt.patientName}</td>
                        <td>${appt.appointmentNotes || 'No notes'}</td>
                        <td>${formatDateTime(appt.appointmentDate, appt.preferredTime)}</td>
                        <td><span style="color: #28a745; font-weight: bold;">${appt.status}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Error loading accepted appointments:', error);
        }
    }

    // NEW FUNCTION: Load X-ray Requests for the table view
    async function loadXRayRequestsTable() {
        try {
            const response = await fetch(`${API_BASE}/xray-requests/dentist`);
            if (!response.ok) {
                throw new Error('Failed to load X-ray requests.');
            }
            const requests = await response.json();
            const tbody = document.querySelector("#xray-requests-table tbody");
            tbody.innerHTML = '';

            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #7f8c8d;">No X-ray requests.</td></tr>';
            } else {
                requests.slice(0, 5).forEach(request => { // Show only latest 5
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${request.patientName}</td>
                        <td>${request.description}</td>
                        <td>${formatDate(request.requestDate)}</td>
                        <td>
                            <span class="x-ray-status ${request.status === 'PENDING' ? 'status-pending' : 'status-completed'}">
                                ${request.status}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            document.getElementById("xray-requests-count").textContent = requests.length;
        } catch (error) {
            console.error("Error loading X-ray requests table:", error);
            const tbody = document.querySelector("#xray-requests-table tbody");
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Error loading X-ray requests.</td></tr>';
        }
    }

    async function updateAppointmentStatus(appointmentId, newStatus) {
        const action = newStatus.toLowerCase();
        if (!confirm(`Are you sure you want to ${action} this appointment?`)) return;
        try {
            const response = await fetch(`${API_BASE}/appointments/${appointmentId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeaderName]: csrfToken
                },
                body: JSON.stringify({ status: newStatus })
            });
            if (response.ok) {
                alert(`Appointment ${action} successfully!`);
                loadAppointmentRequests();
                loadAcceptedAppointments();
            } else {
                const errorText = await response.text();
                alert(`Error: ${errorText}`);
            }
        } catch (error) {
            console.error(`Error updating appointment status:`, error);
            alert('An error occurred. Please try again.');
        }
    }

    // --- EXISTING X-RAY REQUEST FUNCTIONS (UNCHANGED) ---
    async function loadXRayRequests() {
        try {
            const response = await fetch(`${API_BASE}/xray-requests/dentist`);
            if (!response.ok) {
                throw new Error('Failed to load X-ray requests.');
            }
            const requests = await response.json();
            const container = document.getElementById('xRayRequestsContainer');
            container.innerHTML = '';

            if (requests.length === 0) {
                container.innerHTML = `<p class="no-requests-message">No X-ray requests sent. Click 'Create X-ray Request' to get started.</p>`;
            } else {
                requests.forEach(request => addXRayRequestCard(request));
            }
        } catch (error) {
            console.error("Error loading X-ray requests:", error);
            const container = document.getElementById('xRayRequestsContainer');
            container.innerHTML = `<p class="no-requests-message" style="color: red;">Error loading X-ray requests. Please refresh the page.</p>`;
        }
    }

    async function handleXRayRequestSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const patientName = form.elements.patientName.value;
        const description = form.elements.description.value;
        const requestDate = form.elements.requestDate.value;

        const payload = {
            patientName,
            description,
            requestDate
        };

        try {
            const response = await fetch(`${API_BASE}/xray-requests`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeaderName]: csrfToken
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to create X-ray request.');
            }

            const savedRequest = await response.json();
            addXRayRequestCard(savedRequest);
            loadXRayRequestsTable(); // Refresh the table view
            document.getElementById('xRayRequestModal').style.display = 'none';

        } catch (error) {
            console.error("Error creating X-ray request:", error);
            alert("Could not create X-ray request. Please check the console for details.");
        }
    }

    function addXRayRequestCard(request) {
        const container = document.getElementById('xRayRequestsContainer');
        const noRequestsMessage = container.querySelector('.no-requests-message');
        if (noRequestsMessage) {
            noRequestsMessage.remove();
        }

        const newCard = document.createElement('div');
        newCard.classList.add('x-ray-card');

        const displayDate = formatDate(request.requestDate);
        const isCompleted = request.status === 'PROCESSED';
        const statusClass = isCompleted ? 'status-completed' : 'status-pending';
        const buttonDisabled = !isCompleted ? 'disabled' : '';
        const buttonTitle = !isCompleted ? 'X-ray not yet uploaded' : 'View uploaded X-ray';

        newCard.innerHTML = `
            <div class="card-header">
                <h3>${request.patientName}</h3>
                <span class="x-ray-status ${statusClass}">${request.status}</span>
            </div>
            <p><strong>Description:</strong> ${request.description}</p>
            <p><strong>Requested:</strong> ${displayDate}</p>
            ${request.notes ? `<p><strong>Lab Notes:</strong> ${request.notes}</p>` : ''}
            <div class="card-actions">
                <button class="btn btn-view-xray ${buttonDisabled}" title="${buttonTitle}" ${buttonDisabled} onclick="viewXrayImage('${request.imagePath || ''}')">
                    <i class="fas fa-image"></i> View X-ray
                </button>
            </div>
        `;
        container.prepend(newCard);
    }

    function viewXrayImage(imagePath) {
        if (!imagePath) {
            alert('No X-ray image has been uploaded yet for this request.');
            return;
        }

        const modal = document.getElementById('xrayImageModal');
        const modalImg = document.getElementById('modal-image');

        let fullImagePath = imagePath;
        if (!imagePath.startsWith('http') && !imagePath.startsWith('/')) {
            fullImagePath = '/' + imagePath;
        }

        modalImg.src = fullImagePath;
        modal.style.display = "block";
    }
</script>

</body>
</html>